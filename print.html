<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Matrix Authentication Service</title>
                <meta name="robots" content="noindex" />
                

        <!-- Custom HTML head -->
        

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

                <link rel="icon" href="favicon.svg">
                        <link rel="shortcut icon" href="favicon.png">
                <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
                <link rel="stylesheet" href="css/print.css" media="print">
        
        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
                <link rel="stylesheet" href="fonts/fonts.css">
        
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        
            </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><li class="part-title">Introduction</li><li class="chapter-item expanded "><a href="index.html"><strong aria-hidden="true">1.</strong> About this documentation</a></li><li class="chapter-item expanded affix "><li class="part-title">Usage</li><li class="chapter-item expanded "><a href="usage/installation.html"><strong aria-hidden="true">2.</strong> Installation</a></li><li class="chapter-item expanded "><a href="usage/configuration.html"><strong aria-hidden="true">3.</strong> Configuration</a></li><li class="chapter-item expanded "><a href="usage/usage.html"><strong aria-hidden="true">4.</strong> Using the service</a></li><li class="chapter-item expanded "><a href="usage/cli/index.html"><strong aria-hidden="true">5.</strong> Command line tool</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="usage/cli/config.html"><strong aria-hidden="true">5.1.</strong> config</a></li><li class="chapter-item expanded "><a href="usage/cli/database.html"><strong aria-hidden="true">5.2.</strong> database</a></li><li class="chapter-item expanded "><a href="usage/cli/manage.html"><strong aria-hidden="true">5.3.</strong> manage</a></li><li class="chapter-item expanded "><a href="usage/cli/server.html"><strong aria-hidden="true">5.4.</strong> server</a></li><li class="chapter-item expanded "><a href="usage/cli/templates.html"><strong aria-hidden="true">5.5.</strong> templates</a></li></ol></li><li class="chapter-item expanded "><li class="part-title">Development</li><li class="chapter-item expanded "><a href="development/architecture.html"><strong aria-hidden="true">6.</strong> Architecture</a></li><li class="chapter-item expanded "><a href="development/database.html"><strong aria-hidden="true">7.</strong> Database</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">8.</strong> Routing with axum</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">9.</strong> Templates</div></li></ol>            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                                                <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                                            </div>

                    <h1 class="menu-title">Matrix Authentication Service</h1>

                    <div class="right-buttons">
                                                <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                                                                        <a href="https://github.com/matrix-org/matrix-authentication-service" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                                                
                    </div>
                </div>

                                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <div style="break-before: page; page-break-before: always;"></div><h1 id="about-this-documentation"><a class="header" href="#about-this-documentation">About this documentation</a></h1>
<p>This documentation is intended to give an overview of how the <code>matrix-authentication-service</code> works, both from a admin perspective as well as from a developper perspective.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="installation"><a class="header" href="#installation">Installation</a></h1>
<h2 id="requirements"><a class="header" href="#requirements">Requirements</a></h2>
<ul>
<li>A PostgreSQL database</li>
<li>Either:
<ul>
<li>A <a href="https://www.rust-lang.org/learn/get-started">Rust toolchain</a> (recommended for development)</li>
<li>or <a href="https://www.docker.com/get-started">Docker</a> (or a compatible container runtime)</li>
</ul>
</li>
</ul>
<h2 id="installing-from-the-source"><a class="header" href="#installing-from-the-source">Installing from the source</a></h2>
<ol>
<li>Get the source
<pre><code class="language-sh">git clone https://github.com/matrix-org/matrix-authentication-service.git
cd matrix-authentication-service
</code></pre>
</li>
<li>Compile the CLI
<pre><code>cargo build --release
</code></pre>
</li>
<li>Grab the built binary
<pre><code>cp ./target/release/mas-cli ~/.local/bin # Copy the binary somewhere in $PATH
mas-cli --help # Should display the help message
</code></pre>
</li>
</ol>
<h2 id="running-from-the-docker-image"><a class="header" href="#running-from-the-docker-image">Running from the Docker image</a></h2>
<p>A Docker image is available here: <a href="https://ghcr.io/matrix-org/matrix-authentication-service:main"><code>ghcr.io/matrix-org/matrix-authentication-service:main</code></a></p>
<hr />
<pre><code class="language-sh">docker run --rm ghcr.io/matrix-org/matrix-authentication-service:main --help
</code></pre>
<pre><code>mas-cli

USAGE:
    mas-cli [OPTIONS] [SUBCOMMAND]

FLAGS:
    -h, --help       Print help information
    -V, --version    Print version information

OPTIONS:
    -c, --config &lt;CONFIG&gt;...    Path to the configuration file [default: config.yaml]

SUBCOMMANDS:
    config       Configuration-related commands
    database     Manage the database
    help         Print this message or the help of the given subcommand(s)
    manage       Manage the instance
    server       Runs the web server
    templates    Templates-related commands
</code></pre>
<p>Note that when running in a Docker environment</p>
<hr />
<p>The next step is to generate the configuration file and tweak it to reach the PostgreSQL database.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="configuration"><a class="header" href="#configuration">Configuration</a></h1>
<p>The service needs some configuration to work.
This includes random, private keys and secrets.</p>
<p>A sample configuration file can be generated using <code>mas-cli config generate</code>.</p>
<pre><code class="language-sh">mas-cli config generate &gt; config.yaml
mas-cli config check --config=config.yaml
# if --config is omitted, it will try to load `config.yaml`
# in the current working directory
mas-cli config check
</code></pre>
<p>Or, with Docker:</p>
<pre><code class="language-sh">docker run --rm \
  ghcr.io/matrix-org/matrix-authentication-service:main \
  config generate &gt; config.yaml

docker run --rm -v `pwd`:/wd \
  ghcr.io/matrix-org/matrix-authentication-service:main \
  --config=/wd/config.yaml config dump

# or, mounting only the config file and omitting `--config`
docker run --rm -v `pwd`/config.yaml:/config.yaml \
  ghcr.io/matrix-org/matrix-authentication-service:main \
  config dump
</code></pre>
<p>Note that with Docker, the config file must be mounted inside the container with <code>-v/--volume</code>.</p>
<h2 id="minimal-configuration"><a class="header" href="#minimal-configuration">Minimal configuration</a></h2>
<p>Here is a minimal configuration needed to have the server running.
It is strongly recommended to generate the initial configuration using the <code>config generate</code> to have unique secrets and signing keys.
Check the next section to know about each section.</p>
<pre><code class="language-yaml"># config.yaml
database:
  uri: postgresql:///matrix_auth

http:
  public_base: http://localhost:8080

secrets:
  encryption: c7e42fb8baba8f228b2e169fdf4c8216dffd5d33ad18bafd8b928c09ca46c718

  keys:
    - type: rsa
      key: |
        -----BEGIN PRIVATE KEY-----
        MIIEvQIBADANBgkqhkiG9w0BAQEFAASCBKcwggSjAgEAAoIBAQC7iinu0NXjWP5/
        /4OqyqOMI5uLJIHSrYIZLUlWMldtXmNy0c/pan+gxvZogiYx0cNydO/FogNbC4oD
        yj7RIF+QcWJ8wcdG94/P+Xs3HFQzIZfwF+78RWQQJ7nQFekXJ1wQSXV4giw9b4XR
        YkoVhHlyxyYGBFffO//DtYVto4uHvXVL0M27bV6l1K8VKspF72gb8Vt44V8OX5hT
        sEsYW8SjOD1neEoVKiY6XP63cAG9FTB4a4sKkcUqwjrKEYKio/JLujmCl96eLN18
        cuqr6XuSDKvuVJtb+ZNLJi61vIOlD8cz3wu37hr3PCUZ+Ko9Ley+QfopJ3WYFxrI
        IjQKb0W5AgMBAAECggEBAK87ZfsTfwczPHn1Ed4gAbkL/GaC8hscrJdBzWiRGUfE
        DkBW82IydJaR0ePM2EtsqKblxLRxsZj8qzTnYNKe4SxiBZh0p/MTlnjJr+vKuJIe
        LY3VjySA4gKGXASmtGlCCa/eM7kqSJQPBIakxHxej+xDULAGluSrd0wy7D2JtvJY
        5By+2apILUujBZZU/iUyB2AqK6IrzALo2gTV9Jhun9Wz0k3DXZBGd41v42BhZ+Rx
        bHHgpuUTyDQOpKqJ5g1kN4qGlN/CeoontxcE5NOSgtipWeQEuelT8t4eZKHTXBS+
        Byd+uFe8oobWRY2crLptX8TZEENH7wX7y2YgNYUbeZECgYEA95YRhDuukcrDiNuF
        fOXs+99XFORsKTbtZYwrouc7PI2CYb0I9ezoQMu3dzWIwOTUQHea5qCo/dYzbeED
        fNzwPb2zaWaWFbkEWVTOwRewL+NfP+Ek2Nml+dVJm3d35qdIHYV+9gAcI87iCHxA
        gqc13ZS4ba+5/vV6OYwNSAeW0TcCgYEAwem1F9zhVVOIReh3JaJLpZn0xuvZs5kN
        TzvFXar33LKdulk5liC3L7ZrqspGESU0JC3pANR8PwuNteEEdHnkC5UTEqMf/fxG
        j5CObJl+e2CiV2CNbe+3IQ1PKSxopD+Sq65ze7aP2moVZg94mbw4dsN+uY5QEql1
        Bmq0b7Wm2I8CgYBOqlDgefIKgqlEF7O/LnLwyFKr4bP4GGqvZC0NMnkg0TmHAoAR
        W3ej9tZROyI7X7mMzjPaaVuoY2Gt3Nu11aFDjL2vlJfFSSb3lzmmInepj43ZBxkl
        CWpyCfG8QuZG1AnWz266jOhj/DzXQ1tf5+72e2Vp/HaVaruuAzDJHRgvWwKBgAHy
        aMEOlKyYpBufk+Kq2HuXKh/9KjhlZv7OqNKh7s8mc/L1BmD9fxlZiYczdLSjXPyo
        AVjiyUSQxyF2WucYejOrkX90Z9PS/ppeZy+r8tsmQzsBWyopZ/tK+Op+6aYMhVp3
        6+zoDlWxDvnxWdKhUyfOGq2eQiuNzAD+fUVJ25z9AoGARUJ4C87X7vH4QnsIE0g+
        ni0xSs8DgSq0v8+cJ7xwyN+NnC6eeU9N2U/m/5anLEM2GFjo4kghLDkC/2urc8dD
        UtiisQjWz3O88QHqOvclEAmveuxfCYr/A/CWGdkH3YoK+AXIj3fkwb2Qd//rJ9zL
        dT3XPCRatoVKLNKzUGNVcFM=
        -----END PRIVATE KEY-----
    - type: ecdsa
      key: |
        -----BEGIN PRIVATE KEY-----
        MIGEAgEAMBAGByqGSM49AgEGBSuBBAAKBG0wawIBAQQgaa7KvLdq72Nb7i7pGm/6
        SCW0RAKFcVwz7P9/8Wo2TTShRANCAATlTf0uyezm7riXjZdn1XND00uf4d1tc1jc
        V4CiFiDQsDX+3znAGxqhTuoOkVn/G5lwgE1cgTX57r9cyYkso9UY
        -----END PRIVATE KEY-----
</code></pre>
<h2 id="configuration-sections"><a class="header" href="#configuration-sections">Configuration sections</a></h2>
<h3 id="http"><a class="header" href="#http"><code>http</code></a></h3>
<p>Controls the web server.</p>
<pre><code class="language-yaml">http:
  # On what address and port the server should listen to
  address: 0.0.0.0:8080

  # Path from which to serve static files
  web_root: /var/www/static

  # Public URL base used when building absolute public URLs
  public_base: http://localhost:8080
</code></pre>
<h3 id="database"><a class="header" href="#database"><code>database</code></a></h3>
<p>Configure how to connect to the PostgreSQL database.</p>
<pre><code class="language-yaml">database:
  # Full connection string as per
  # https://www.postgresql.org/docs/13/libpq-connect.html#id-1.7.3.8.3.6
  uri: postgresql://user:password@hostname:5432/database?sslmode=require

  # -- OR --
  # Separate parameters
  host: hostname
  port: 5432
  #socket:
  username: user
  password: password
  database: database

  # Additional parameters for the connection pool
  min_connections: 0
  max_connections: 10
  connect_timeout: 30
  idle_timeout: 600
  max_lifetime: 1800
</code></pre>
<h3 id="templates"><a class="header" href="#templates"><code>templates</code></a></h3>
<p>Allows loading custom templates</p>
<pre><code class="language-yaml">templates:
  # From where to load the templates
  # This is relative to the current working directory, *not* the config file
  path: /to/templates

  # Whether builtin should be loaded or not
  builtin: true
</code></pre>
<h3 id="clients"><a class="header" href="#clients"><code>clients</code></a></h3>
<p>List of OAuth 2.0/OIDC clients and their keys/secrets.</p>
<pre><code class="language-yaml">clients:
  # Confidential client
  - client_id: first
    client_auth_method: clent_secret_post
    client_secret: secret
    # List of authorized redirect URIs
    redirect_uris:
      - http://localhost:1234/callback
  # Public client
  - client_id: second
    client_auth_method: none
</code></pre>
<h3 id="secrets"><a class="header" href="#secrets"><code>secrets</code></a></h3>
<p>Signing and encryption secrets</p>
<pre><code class="language-yaml">secrets:
  # Encrytion secret (used for encrypting cookies)
  encryption: c7e42fb8baba8f228b2e169fdf4c8216dffd5d33ad18bafd8b928c09ca46c718

  # Signing keys
  keys:
    # It needs at least an RSA key to work properly
    - type: &quot;rsa&quot;
      key: |
        -----BEGIN PRIVATE KEY-----
        MIIEvQIBADANBgkqhkiG9w0BAQEFAASCBKcwggSjAgEAAoIBAQC7iinu0NXjWP5/
        /4OqyqOMI5uLJIHSrYIZLUlWMldtXmNy0c/pan+gxvZogiYx0cNydO/FogNbC4oD
        yj7RIF+QcWJ8wcdG94/P+Xs3HFQzIZfwF+78RWQQJ7nQFekXJ1wQSXV4giw9b4XR
        YkoVhHlyxyYGBFffO//DtYVto4uHvXVL0M27bV6l1K8VKspF72gb8Vt44V8OX5hT
        sEsYW8SjOD1neEoVKiY6XP63cAG9FTB4a4sKkcUqwjrKEYKio/JLujmCl96eLN18
        cuqr6XuSDKvuVJtb+ZNLJi61vIOlD8cz3wu37hr3PCUZ+Ko9Ley+QfopJ3WYFxrI
        IjQKb0W5AgMBAAECggEBAK87ZfsTfwczPHn1Ed4gAbkL/GaC8hscrJdBzWiRGUfE
        DkBW82IydJaR0ePM2EtsqKblxLRxsZj8qzTnYNKe4SxiBZh0p/MTlnjJr+vKuJIe
        LY3VjySA4gKGXASmtGlCCa/eM7kqSJQPBIakxHxej+xDULAGluSrd0wy7D2JtvJY
        5By+2apILUujBZZU/iUyB2AqK6IrzALo2gTV9Jhun9Wz0k3DXZBGd41v42BhZ+Rx
        bHHgpuUTyDQOpKqJ5g1kN4qGlN/CeoontxcE5NOSgtipWeQEuelT8t4eZKHTXBS+
        Byd+uFe8oobWRY2crLptX8TZEENH7wX7y2YgNYUbeZECgYEA95YRhDuukcrDiNuF
        fOXs+99XFORsKTbtZYwrouc7PI2CYb0I9ezoQMu3dzWIwOTUQHea5qCo/dYzbeED
        fNzwPb2zaWaWFbkEWVTOwRewL+NfP+Ek2Nml+dVJm3d35qdIHYV+9gAcI87iCHxA
        gqc13ZS4ba+5/vV6OYwNSAeW0TcCgYEAwem1F9zhVVOIReh3JaJLpZn0xuvZs5kN
        TzvFXar33LKdulk5liC3L7ZrqspGESU0JC3pANR8PwuNteEEdHnkC5UTEqMf/fxG
        j5CObJl+e2CiV2CNbe+3IQ1PKSxopD+Sq65ze7aP2moVZg94mbw4dsN+uY5QEql1
        Bmq0b7Wm2I8CgYBOqlDgefIKgqlEF7O/LnLwyFKr4bP4GGqvZC0NMnkg0TmHAoAR
        W3ej9tZROyI7X7mMzjPaaVuoY2Gt3Nu11aFDjL2vlJfFSSb3lzmmInepj43ZBxkl
        CWpyCfG8QuZG1AnWz266jOhj/DzXQ1tf5+72e2Vp/HaVaruuAzDJHRgvWwKBgAHy
        aMEOlKyYpBufk+Kq2HuXKh/9KjhlZv7OqNKh7s8mc/L1BmD9fxlZiYczdLSjXPyo
        AVjiyUSQxyF2WucYejOrkX90Z9PS/ppeZy+r8tsmQzsBWyopZ/tK+Op+6aYMhVp3
        6+zoDlWxDvnxWdKhUyfOGq2eQiuNzAD+fUVJ25z9AoGARUJ4C87X7vH4QnsIE0g+
        ni0xSs8DgSq0v8+cJ7xwyN+NnC6eeU9N2U/m/5anLEM2GFjo4kghLDkC/2urc8dD
        UtiisQjWz3O88QHqOvclEAmveuxfCYr/A/CWGdkH3YoK+AXIj3fkwb2Qd//rJ9zL
        dT3XPCRatoVKLNKzUGNVcFM=
        -----END PRIVATE KEY-----
    - type: &quot;ecdsa&quot;
      key: |
        -----BEGIN PRIVATE KEY-----
        MIGEAgEAMBAGByqGSM49AgEGBSuBBAAKBG0wawIBAQQgaa7KvLdq72Nb7i7pGm/6
        SCW0RAKFcVwz7P9/8Wo2TTShRANCAATlTf0uyezm7riXjZdn1XND00uf4d1tc1jc
        V4CiFiDQsDX+3znAGxqhTuoOkVn/G5lwgE1cgTX57r9cyYkso9UY
        -----END PRIVATE KEY-----
</code></pre>
<h3 id="policy"><a class="header" href="#policy"><code>policy</code></a></h3>
<p>Policy settings</p>
<pre><code class="language-yaml">policy:
  data:
    admin_users:
      - person1
      - person2

    # Dynamic Client Registration
    client_registration:
      # don't require URIs to be on the same host. default: false
      allow_host_mismatch: true
      # allow non-SSL and localhost URIs. default: false
      allow_insecure_uris: true

    # Registration using passwords
    passwords: 
      # minimum length of a password. default: ?
      min_length: 8
      # require at least one lowercase character in a password. default: false
      require_lowercase: true
      # require at least one uppercase character in a password. default: false
      require_uppercase: true
      # require at least one number in a password. default: false
      require_number: true
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="using-the-service"><a class="header" href="#using-the-service">Using the service</a></h1>
<h2 id="running"><a class="header" href="#running">Running</a></h2>
<p>Once the configuration is done, one should run the database migrations by running</p>
<pre><code class="language-sh">mas-cli database migrate
</code></pre>
<p>The server can then be started by running</p>
<pre><code class="language-sh">mas-cli server
</code></pre>
<pre><code>Sep 24 14:42:42.743  INFO mas_cli::server: Starting task scheduler
Sep 24 14:42:42.743  INFO mas_core::templates: Loading builtin templates
Sep 24 14:42:42.752  INFO mas_cli::server: Listening on http://0.0.0.0:8080
</code></pre>
<p>The server should now be accessible through <a href="http://localhost:8080/">http://localhost:8080/</a>.</p>
<p><strong>Note</strong>: when running with Docker, the port used by the server should be exposed with the <code>-p</code> flag:</p>
<pre><code class="language-sh">docker run --rm \
  -v `pwd`/config.yaml:/config.yaml \
  -p 8080:8080 \
  ghcr.io/matrix-org/matrix-authentication-service:main \
  server
</code></pre>
<h2 id="registering-logging-in-and-out"><a class="header" href="#registering-logging-in-and-out">Registering, logging in and out</a></h2>
<p>Through the interface, users are able to create an account by clicking the <code>Register</code> button on the top right (or going to <a href="http://localhost:8080/register"><code>/register</code></a>.
They can then end their session by clicking the <code>Sign out</code> button and sign back in.</p>
<h2 id="playing-around-with-the-playground"><a class="header" href="#playing-around-with-the-playground">Playing around with the playground</a></h2>
<p>The OpenID Foundation hosts a OpenID Connect Playground where one can test logging in through an OIDC provider: https://openidconnect.net/</p>
<h3 id="step-1-add-the-client-to-the-server-config"><a class="header" href="#step-1-add-the-client-to-the-server-config">Step 1: Add the client to the server config</a></h3>
<p>Add the following section to the server configuration file <code>config.yaml</code>:</p>
<pre><code class="language-yaml">clients:
  - client_id: oidc-playground
    client_secret: verysecret
    redirect_uris:
      - &quot;https://openidconnect.net/callback&quot;
</code></pre>
<h3 id="step-2-change-the-playground-configuration"><a class="header" href="#step-2-change-the-playground-configuration">Step 2: Change the playground configuration</a></h3>
<ul>
<li>Navigate to <a href="https://openidconnect.net/">the playground</a></li>
<li>Click on &quot;Configuration&quot;</li>
<li>Server template: <em>Custom</em></li>
<li>Paste the discovery document URL found on the service homepage (e.g. <code>http://localhost:8080/.well-known/openid-configuration</code>)</li>
<li>Click &quot;Use discovery document&quot; ; it should fill out the authorization, token and token keys endpoints</li>
<li>Set the OIDC Client ID to <code>oidc-playground</code> and the Client Secret to <code>verysecret</code> (must match the ones in the configuration)</li>
<li>Click &quot;Save&quot;</li>
</ul>
<h3 id="step-3-run-the-openid-connect-flow"><a class="header" href="#step-3-run-the-openid-connect-flow">Step 3: Run the OpenID Connect flow</a></h3>
<p>Start the flow by clicking the &quot;Start&quot; button.
It should redirect the browser to the authentication service.
If a user is already logged in, it should redirect back to the playground immediately.</p>
<p>Follow the flow to see the code exchange happen.
Note that the last step only works if the service is accessible through the internet.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="command-line-tool"><a class="header" href="#command-line-tool">Command line tool</a></h1>
<p>The command line interface provides subcommands that helps running the service.</p>
<h2 id="logging"><a class="header" href="#logging">Logging</a></h2>
<p>The overall log level of the CLI can be changed via the <code>RUST_LOG</code> environment variable.
Default log level is <code>info</code>.
Valid levels from least to most verbose are <code>error</code>, <code>warn</code>, <code>info</code>, <code>debug</code> and <code>trace</code>.</p>
<h2 id="global-flags"><a class="header" href="#global-flags">Global flags</a></h2>
<h3 id="--config"><a class="header" href="#--config"><code>--config</code></a></h3>
<p>Sets the configuration file to load.
It can be repeated multiple times to merge multiple files together.</p>
<hr />
<pre><code>mas-cli

USAGE:
    mas-cli [OPTIONS] [SUBCOMMAND]

FLAGS:
    -h, --help       Print help information
    -V, --version    Print version information

OPTIONS:
    -c, --config &lt;CONFIG&gt;...    Path to the configuration file [default: config.yaml]

SUBCOMMANDS:
    config       Configuration-related commands
    database     Manage the database
    help         Print this message or the help of the given subcommand(s)
    manage       Manage the instance
    server       Runs the web server
    templates    Templates-related commands
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="config"><a class="header" href="#config"><code>config</code></a></h1>
<p>Helps dealing with the configuration</p>
<h2 id="config-check"><a class="header" href="#config-check"><code>config check</code></a></h2>
<p>Check the validity of configuration files.</p>
<pre><code class="language-console">$ mas-cli config check --config=config.yaml
INFO mas_cli::config: Configuration file looks good path=[&quot;config.yaml&quot;]
</code></pre>
<h2 id="config-dump"><a class="header" href="#config-dump"><code>config dump</code></a></h2>
<p>Dump the merged configuration tree.</p>
<pre><code class="language-console">$ mas-cli config dump --config=first.yaml --config=second.yaml
---
clients:
  # ...
</code></pre>
<h2 id="config-generate"><a class="header" href="#config-generate"><code>config generate</code></a></h2>
<p>Generate a sample configuration file.
It generates random signing keys (<code>.secrets.keys</code>) and the cookie encryption secret (<code>.secrets.encryption</code>).</p>
<pre><code class="language-console">$ mas-cli config generate &gt; config.yaml
INFO generate: mas_config::oauth2: Generating keys...
INFO generate:rsa: mas_config::oauth2: Done generating RSA key
INFO generate:ecdsa: mas_config::oauth2: Done generating ECDSA key
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="database-1"><a class="header" href="#database-1"><code>database</code></a></h1>
<p>Run database-related operations</p>
<h2 id="database-migrate"><a class="header" href="#database-migrate"><code>database migrate</code></a></h2>
<p>Run the pending database migrations</p>
<pre><code>$ mas-cli database migrate
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="manage"><a class="header" href="#manage"><code>manage</code></a></h1>
<p>Includes admin-related subcommands.</p>
<h2 id="manage-register-username-password"><a class="header" href="#manage-register-username-password"><code>manage register &lt;username&gt; &lt;password&gt;</code></a></h2>
<p>Register a new user</p>
<pre><code class="language-console">$ mas-cli manage register johndoe hunter2
INFO mas_cli::manage: User registered user=User { id: 2, username: &quot;johndoe&quot; }
</code></pre>
<h2 id="manage-verify-email-username-email"><a class="header" href="#manage-verify-email-username-email"><code>manage verify-email &lt;username&gt; &lt;email&gt;</code></a></h2>
<p>Mark a user email address as verified</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="server"><a class="header" href="#server"><code>server</code></a></h1>
<p>Runs the authentication service.</p>
<pre><code>$ mas-cli server
INFO mas_cli::server: Starting task scheduler
INFO mas_core::templates: Loading builtin templates
INFO mas_cli::server: Listening on http://0.0.0.0:8080
</code></pre>
<p>A <code>--migrate</code> flag can be set to automatically run pending database migrations on startup.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="templates-1"><a class="header" href="#templates-1"><code>templates</code></a></h1>
<p>Helps customizing templates.</p>
<h2 id="templates-save-path"><a class="header" href="#templates-save-path"><code>templates save &lt;path&gt;</code></a></h2>
<p>Save the builtin template in the specified folder.</p>
<pre><code class="language-console">$ mas-cli templates save ./templates
INFO mas_core::templates: Wrote template path=&quot;./templates/login.html&quot;
INFO mas_core::templates: Wrote template path=&quot;./templates/register.html&quot;
INFO mas_core::templates: Wrote template path=&quot;./templates/index.html&quot;
INFO mas_core::templates: Wrote template path=&quot;./templates/reauth.html&quot;
INFO mas_core::templates: Wrote template path=&quot;./templates/form_post.html&quot;
INFO mas_core::templates: Wrote template path=&quot;./templates/error.html&quot;
INFO mas_core::templates: Wrote template path=&quot;./templates/base.html&quot;
</code></pre>
<p>By default this command won't overwrite existing files, but this behavior can be changed by adding the <code>--overwrite</code> flag.</p>
<h2 id="templates-check-path"><a class="header" href="#templates-check-path"><code>templates check &lt;path&gt;</code></a></h2>
<p>Check the validity of the templates in the specified folder.
It compiles the templates and then renders them with different contexts.</p>
<pre><code class="language-console">$ mas-cli templates check ./templates
INFO mas_core::templates: Loading builtin templates
INFO mas_core::templates: Loading templates from filesystem path=./templates/**/*.{html,txt}
INFO mas_core::templates::check: Rendering template name=&quot;login.html&quot; context={&quot;csrf_token&quot;:&quot;fake_csrf_token&quot;,&quot;form&quot;:{&quot;fields_errors&quot;:{},&quot;form_errors&quot;:[],&quot;has_errors&quot;:false}}
INFO mas_core::templates::check: Rendering template name=&quot;register.html&quot; context={&quot;__UNUSED&quot;:null,&quot;csrf_token&quot;:&quot;fake_csrf_token&quot;}
INFO mas_core::templates::check: Rendering template name=&quot;index.html&quot; context={&quot;csrf_token&quot;:&quot;fake_csrf_token&quot;,&quot;current_session&quot;:{&quot;active&quot;:true,&quot;created_at&quot;:&quot;2021-09-24T13:26:52.962135085Z&quot;,&quot;id&quot;:1,&quot;last_authd_at&quot;:&quot;2021-09-24T13:26:52.962135316Z&quot;,&quot;user_id&quot;:2,&quot;username&quot;:&quot;john&quot;},&quot;discovery_url&quot;:&quot;https://example.com/.well-known/openid-configuration&quot;}
...
</code></pre>
<p>Builtin templates are still loaded by default when running this command, but this can be skipped by adding the <code>--skip-builtin</code> flag.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="architecture"><a class="header" href="#architecture">Architecture</a></h1>
<p>The service is meant to be easily embeddable, with only a dependency to a database.
It is also meant to stay lightweight in terms of resource usage and easily scalable horizontally.</p>
<h2 id="workspace-and-crate-split"><a class="header" href="#workspace-and-crate-split">Workspace and crate split</a></h2>
<p>The whole repository is a <a href="https://doc.rust-lang.org/book/ch14-03-cargo-workspaces.html">Cargo Workspace</a> that includes multiple crates under the <code>/crates</code> directory.</p>
<p>This includes:</p>
<ul>
<li><code>mas-cli</code>: Command line utility, main entry point</li>
<li><code>mas-config</code>: Configuration parsing and loading</li>
<li><code>mas-data-model</code>: Models of objects that live in the database, regardless of the storage backend</li>
<li><code>mas-email</code>: High-level email sending abstraction</li>
<li><code>mas-handlers</code>: Main HTTP application logic</li>
<li><code>mas-iana</code>: Auto-generated enums from IANA registries</li>
<li><code>mas-iana-codegen</code>: Code generator for the <code>mas-iana</code> crate</li>
<li><code>mas-jose</code>: JWT/JWS/JWE/JWK abstraction</li>
<li><code>mas-static-files</code>: Frontend static files (CSS/JS). Includes some frontend tooling</li>
<li><code>mas-storage</code>: Interactions with the database</li>
<li><code>mas-tasks</code>: Asynchronous task runner and scheduler</li>
<li><code>oauth2-types</code>: Useful structures and types to deal with OAuth 2.0/OpenID Connect endpoints. This might end up published as a standalone library as it can be useful in other contexts.</li>
</ul>
<h2 id="important-crates"><a class="header" href="#important-crates">Important crates</a></h2>
<p>The project makes use of a few important crates.</p>
<h3 id="async-runtime-tokio"><a class="header" href="#async-runtime-tokio">Async runtime: <code>tokio</code></a></h3>
<p><a href="https://tokio.rs/">Tokio</a> is the async runtime used by the project.
The choice of runtime does not have much impact on most of the code.</p>
<p>It has an impact when:</p>
<ul>
<li>spawning asynchronous work (as in &quot;not awaiting on it immediately&quot;)</li>
<li>running CPU-intensive tasks. They should be ran in a blocking context using <code>tokio::task::spawn_blocking</code>. This includes password hashing and other crypto operations.</li>
<li>when dealing with shared memory, e.g. mutexes, rwlocks, etc.</li>
</ul>
<h3 id="logging-tracing"><a class="header" href="#logging-tracing">Logging: <code>tracing</code></a></h3>
<p>Logging is handled through the <a href="https://docs.rs/tracing/*/tracing/"><code>tracing</code></a> crate.
It provides a way to emit structured log messages at various levels.</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>use tracing::{info, debug};

info!(&quot;Logging some things&quot;);
debug!(user = &quot;john&quot;, &quot;Structured stuff&quot;);
<span class="boring">}
</span></code></pre></pre>
<p><code>tracing</code> also provides ways to create spans to better understand where a logging message comes from.
In the future, it will help building OpenTelemetry-compatible distributed traces to help with debugging.</p>
<p><code>tracing</code> is becoming the standard to log things in Rust.
By itself it will do nothing unless a subscriber is installed to -for example- log the events to the console.</p>
<p>The CLI installs <a href="https://docs.rs/tracing-subscriber/*/tracing_subscriber/"><code>tracing-subcriber</code></a> on startup to log in the console.
It looks for a <code>RUST_LOG</code> environment variable to determine what event should be logged.</p>
<h3 id="error-management-thiserror--anyhow"><a class="header" href="#error-management-thiserror--anyhow">Error management: <code>thiserror</code> / <code>anyhow</code></a></h3>
<p><a href="https://docs.rs/thiserror/*/thiserror/"><code>thiserror</code></a> helps defining custom error types.
This is especially useful for errors that should be handled in a specific way, while being able to augment underlying errors with additional context.</p>
<p><a href="https://docs.rs/anyhow/*/anyhow/"><code>anyhow</code></a> helps dealing with chains of errors.
It allows for quickly adding additional context around an error while it is being propagated.</p>
<p>Both crates work well together and complement each other.</p>
<h3 id="database-interactions-sqlx"><a class="header" href="#database-interactions-sqlx">Database interactions: <code>sqlx</code></a></h3>
<p>Interactions with the database are done through <a href="https://github.com/launchbadge/sqlx"><code>sqlx</code></a>, an async, pure-Rust SQL library with compile-time check of queries.
It also handles schema migrations.</p>
<h3 id="templates-tera"><a class="header" href="#templates-tera">Templates: <code>tera</code></a></h3>
<p><a href="https://tera.netlify.app/">Tera</a> was chosen as template engine for its simplicity as well as its ability to load templates at runtime.
The builtin templates are embedded in the final binary through some macro magic.</p>
<p>The downside of Tera compared to compile-time template engines is the possibility of runtime crashes.
This can however be somewhat mitigated with unit tests.</p>
<h3 id="crates-from-rustcrypto"><a class="header" href="#crates-from-rustcrypto">Crates from <em>RustCrypto</em></a></h3>
<p>The <a href="https://github.com/RustCrypto">RustCrypto team</a> offer high quality, independent crates for dealing with cryptography.
The whole project is highly modular and APIs are coherent between crates.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="database-2"><a class="header" href="#database-2">Database</a></h1>
<p>Interactions with the database goes through <code>sqlx</code>.
It provides async database operations with connection pooling, migrations support and compile-time check of queries through macros.</p>
<h2 id="compile-time-check-of-queries"><a class="header" href="#compile-time-check-of-queries">Compile-time check of queries</a></h2>
<p>To be able to check queries, <code>sqlx</code> has to introspect the live database.
Usually it does so by having the database available at compile time, but to avoid that we're using the <code>offline</code> feature of <code>sqlx</code>, which saves the introspection informatons as a flat file in the repository.</p>
<p>Preparing this flat file is done through <code>sqlx-cli</code>, and should be done everytime the database schema or the queries changed.</p>
<pre><code class="language-sh"># Install the CLI
cargo install sqlx-cli --no-default-features --features postgres

cd crates/storage/ # Must be in the mas-storage crate folder
export DATABASE_URL=postgresql:///matrix_auth
cargo sqlx prepare
</code></pre>
<h2 id="migrations"><a class="header" href="#migrations">Migrations</a></h2>
<p>Migration files live in the <code>migrations</code> folder in the <code>mas-core</code> crate.</p>
<pre><code class="language-sh">cd crates/storage/ # Again, in the mas-storage crate folder
export DATABASE_URL=postgresql:///matrix_auth
cargo sqlx migrate run # Run pending migrations
cargo sqlx migrate revert # Revert the last migration
cargo sqlx migrate add -r [description] # Add new migration files
</code></pre>
<p>Note that migrations are embedded in the final binary and can be run from the service CLI tool.</p>
<h2 id="writing-database-interactions"><a class="header" href="#writing-database-interactions">Writing database interactions</a></h2>
<p>A typical interaction with the database look like this:</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>pub async fn lookup_session(
    executor: impl Executor&lt;'_, Database = Postgres&gt;,
    id: i64,
) -&gt; anyhow::Result&lt;SessionInfo&gt; {
    sqlx::query_as!(
        SessionInfo, // Struct that will be filled with the result
        r#&quot;
            SELECT
                s.id,
                u.id as user_id,
                u.username,
                s.active,
                s.created_at,
                a.created_at as &quot;last_authd_at?&quot;
            FROM user_sessions s
            INNER JOIN users u 
                ON s.user_id = u.id
            LEFT JOIN user_session_authentications a
                ON a.session_id = s.id
            WHERE s.id = $1
            ORDER BY a.created_at DESC
            LIMIT 1
        &quot;#,
        id, // Query parameter
    )
    .fetch_one(executor)
    .await
    // Providing some context when there is an error
    .context(&quot;could not fetch session&quot;)
}
<span class="boring">}
</span></code></pre></pre>
<p>Note that we pass an <code>impl Executor</code> as parameter here.
This allows us to use this function from either a simple connection or from an active transaction.</p>
<p>The caveat here is that the <code>executor</code> can be used only once, so if an interaction needs to do multiple queries, it should probably take an <code>impl Acquire</code> to then acquire a transaction and do multiple interactions.</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>pub async fn login(
    conn: impl Acquire&lt;'_, Database = Postgres&gt;,
    username: &amp;str,
    password: String,
) -&gt; Result&lt;SessionInfo, LoginError&gt; {
    let mut txn = conn.begin().await.context(&quot;could not start transaction&quot;)?;
    // First interaction
    let user = lookup_user_by_username(&amp;mut txn, username)?;
    // Second interaction
    let mut session = start_session(&amp;mut txn, user).await?;
    // Third interaction
    session.last_authd_at = 
        Some(authenticate_session(&amp;mut txn, session.id, password).await?);
    // Commit the transaction once everything went fine
    txn.commit().await.context(&quot;could not commit transaction&quot;)?;
    Ok(session)
}
<span class="boring">}
</span></code></pre></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                        
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                            </nav>

        </div>

        
        
        
                <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        
        
                <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        
        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        
                        <script type="text/javascript">
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>
                
    </body>
</html>
